name: Sync Learning Notes

on:
  push:
    branches: [master, main]
    paths:
      - 'CLAUDE.md'
      - 'DEVLOG.md'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout learning repo
        uses: actions/checkout@v4
        with:
          repository: shimwoojin/claude-learning
          token: ${{ secrets.LEARNING_REPO_TOKEN }}
          path: claude-learning

      - name: Extract project info
        id: project
        run: |
          PROJECT_NAME=$(basename $GITHUB_REPOSITORY)
          echo "name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          # Use 'portfolio' for shimwoojin-portfolio to match existing VitePress config
          if [ "$PROJECT_NAME" = "shimwoojin-portfolio" ]; then
            echo "file_name=portfolio" >> $GITHUB_OUTPUT
          else
            echo "file_name=$(echo $PROJECT_NAME | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
          fi

      - name: Generate learning note
        run: |
          PROJECT_NAME="${{ steps.project.outputs.name }}"
          FILE_NAME="${{ steps.project.outputs.file_name }}"
          TARGET_FILE="claude-learning/docs/projects/${FILE_NAME}.md"
          mkdir -p claude-learning/docs/projects
          echo "# ${PROJECT_NAME}" > "$TARGET_FILE"
          echo "" >> "$TARGET_FILE"
          echo "## 프로젝트 개요" >> "$TARGET_FILE"
          if [ -f "CLAUDE.md" ]; then
            sed -n '/## 프로젝트 개요/,/## /p' CLAUDE.md | head -n -1 >> "$TARGET_FILE"
          fi
          echo "" >> "$TARGET_FILE"
          echo "## 최근 개발 로그" >> "$TARGET_FILE"
          if [ -f "DEVLOG.md" ]; then
            head -100 DEVLOG.md >> "$TARGET_FILE"
          fi
          echo "---" >> "$TARGET_FILE"
          echo "*마지막 동기화: $(date +%Y-%m-%d)*" >> "$TARGET_FILE"
          echo "*소스: [${PROJECT_NAME}](https://github.com/$GITHUB_REPOSITORY)*" >> "$TARGET_FILE"

      - name: Commit and push
        run: |
          cd claude-learning
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update ${{ steps.project.outputs.name }} learning notes"
            git push
          fi
